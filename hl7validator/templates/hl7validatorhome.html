<!DOCTYPE html>
<html lang="{{ g.current_lang }}">

<head>
    <meta charset="UTF-8">
    <title>{{ _('HL7 Validator') }}</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/static/mystyle.css" rel="stylesheet" media="screen">
    <style>
        .language-selector {
            float: right;
            margin-top: 20px;
        }
        .language-selector a {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .language-selector a:hover {
            background-color: #0056b3;
        }
        .language-selector a.active {
            background-color: #28a745;
        }
    </style>
</head>

<body>
<div class="container-fluid px-5">
    <div class="row align-items-center">
        <div class="col-2">
            <img style="float:left; width:70%;" src="/static/hl7pt.png" class="rounded float-left" alt="HL7PT">
        </div>
        <div class="col-8">
            <h1>{{ _('HL7 V2 Validator') }} <a style="font-size:x-small">{{ _('Version') }}: {{version}}</a></h1>
        </div>
        <div class="col-2">
            <div class="language-selector">
                <a href="{{ url_for('set_language', language='en') }}" class="{% if g.current_lang == 'en' %}active{% endif %}" title="English">EN</a>
                <a href="{{ url_for('set_language', language='pt') }}" class="{% if g.current_lang == 'pt' %}active{% endif %}" title="PortuguÃªs">PT</a>
            </div>
        </div>
    </div>

    <form method="POST" role="form">
        <div class="form-group">
            <label for="exampleFormControlTextarea1">
                <h3>{{ _('Validate an HL7 version 2 message or convert to CSV') }}</h3>
            </label>

            <div class="row align-items-center mb-3">
                <div class="col-lg-2 ">
                    <label class="radio-inline">
                        <input type="radio" name="options" value="hl7v2" checked> {{ _('HL7 V2') }}
                    </label>
                </div>

                <div class="col-lg-3">
                    <label class="radio-inline">
                        <input type="radio" name="options" value="converter">{{ _('Convert HL7 V2 to CSV') }}
                    </label>
                </div>

                <div class="col-lg-4">
                    <label for="validation_level">{{ _('Validation Level') }}:</label>
                    <select name="validation_level" id="validation_level" class="form-select form-select-sm">
                        <option value="tolerant" selected>{{ _('Tolerant') }}</option>
                        <option value="strict">{{ _('Strict') }}</option>
                    </select>
                </div>
            </div>
            <textarea class="form-control" id="exampleFormControlTextarea1" name="msg" rows="7">{{ msg }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary">{{ _('Submit') }}</button>
        <button type="button" class="btn btn-secondary" onclick="clearContent()">{{ _('Clear') }}</button>
        <p>{{ _('Use as API? See') }} <a href="/apidocs">{{ _('here') }}</a>.
            <br>
            {{ _('Detected an error? Please send email to') }} <a href="mailto:tech@hl7.pt">tech [at] hl7.pt</a></p>

    </form>
    <br>

    {% if title %}
    <div id="validationTitle">
        <h3>{{ _('Validation') }}</h3>
        <p><strong>{{ _('Status') }}:</strong> {{ title }}</p>
        {% if hl7version %}
        <p><strong>{{ _('Detected HL7 Version') }}:</strong> {{ hl7version }}</p>
        {% endif %}
    </div>
    {% endif %}

    {% if result %}
    <div id="validationResults">
        <h4>{{ _('Report') }}</h4>
        <table class="table">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">{{ _('Level') }}</th>
                <th scope="col">{{ _('Message') }}</th>
            </tr>
            </thead>
            <tbody>
            {% for foo in result %}
            <tr >
                <th scope="row">{{loop.index}}</th>
                <td class="{{foo["level"]}}level">{{ foo["level"] }}</td>
                <td>{{ foo["message"] }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if tree %}
        <p id="viewButtons">
          <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseTreeView" role="button" aria-expanded="false" aria-controls="collapseTreeView">
            {{ _('Click to view tree structure') }}
          </a>
          <a class="btn btn-secondary" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
            {{ _('Click to view structured message') }}
          </a>
        </p>

        <div class="collapse" id="collapseTreeView">
          <div class="card card-body">
            {% if hl7version %}
            <p>{{ _('For more information, see the specification') }} <a href="https://hl7-definition.caristix.com/v2/HL7v{{hl7version}}" target="_blank"> {{ _('of version') }} {{hl7version}} {{ _('here') }}</a>. {{ _('Click on ðŸ“– to view segment specification') }}.</p>
            {% endif %}
            <div class="mb-3">
              <button class="btn btn-sm btn-outline-primary" onclick="expandAll()">{{ _('Expand All') }}</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">{{ _('Collapse All') }}</button>
            </div>
            {{tree|safe}}
          </div>
        </div>

        <div class="collapse" id="collapseExample">
          <div class="card card-body">
            {% if hl7version %}
            <p>{{ _('For more information, see the specification') }} <a href="https://hl7-definition.caristix.com/v2/HL7v{{hl7version}}" target="_blank"> {{ _('of version') }} {{hl7version}} {{ _('here') }}</a>. {{ _('Or click on the segment identifier to view the specification') }}.</p>
            {% endif %}
            {{parsed|safe}}
          </div>
        </div>
      <br>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</body>
<footer>
</footer>
<script>
    function clearContent() {
        // Clear textarea
        document.getElementById('exampleFormControlTextarea1').value = '';

        // Hide validation title
        const validationTitle = document.getElementById('validationTitle');
        if (validationTitle) {
            validationTitle.style.display = 'none';
        }

        // Hide view buttons
        const viewButtons = document.getElementById('viewButtons');
        if (viewButtons) {
            viewButtons.style.display = 'none';
        }

        // Hide tree view
        const collapseTreeView = document.getElementById('collapseTreeView');
        if (collapseTreeView) {
            collapseTreeView.style.display = 'none';
        }

        // Hide structured message view
        const collapseExample = document.getElementById('collapseExample');
        if (collapseExample) {
            collapseExample.style.display = 'none';
        }

        // Hide validation results table
        const validationResults = document.getElementById('validationResults');
        if (validationResults) {
            validationResults.style.display = 'none';
        }
    }

    function toggleNode(element) {
        const toggleIcon = element.querySelector('.toggle-icon');
        const childrenContainer = element.nextElementSibling;

        if (childrenContainer && childrenContainer.classList.contains('tree-children')) {
            if (childrenContainer.style.display === 'none') {
                childrenContainer.style.display = 'block';
                toggleIcon.classList.add('expanded');
            } else {
                childrenContainer.style.display = 'none';
                toggleIcon.classList.remove('expanded');
            }
        }
    }

    function expandAll() {
        const allChildren = document.querySelectorAll('.tree-children');
        const allIcons = document.querySelectorAll('.toggle-icon');

        allChildren.forEach(child => {
            child.style.display = 'block';
        });

        allIcons.forEach(icon => {
            icon.classList.add('expanded');
        });
    }

    function collapseAll() {
        const allChildren = document.querySelectorAll('.tree-children');
        const allIcons = document.querySelectorAll('.toggle-icon');

        allChildren.forEach(child => {
            child.style.display = 'none';
        });

        allIcons.forEach(icon => {
            icon.classList.remove('expanded');
        });
    }
    </script>
</html>
